<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<div layout:fragment="content" class="py-5">
    <script src="/public/js/CommLike.js" defer></script>
<style>
    #mbtiChk>a{
        text-decoration: none;
        color: #7c7cff;
    }
    #mbtiChk>a:hover{
        color:black;
    }
</style>
    <div class="w-75 mx-auto my-4">
        <div class="card" >
            <div class="card-body d-flex justify-content-between align-items-center">
                <div  class="col-1 me-1" >
                    <a href="" class="profile">
                        <img class="profile img-thumbnail rounded-circle w-100 h-100" style="image-size:cover"
                         th:src="@{'{path}'(path=${c.user.imgPath})}">
                    </a>
<!--                         th:src="@{'{path}'(path=${c.user.imgPath})}">-->
                </div>
                <div class="col-2 text-center" >
                    <a href="#" th:text="${c.user.nkName}" class="profile pb-0 text-decoration-none fw-bold"></a><br>
                    (@<small th:text="${c.user.uId}"></small>)
                </div>
                <h4 class="card-title col-7" th:text="${c.title}"></h4>
                <div class="col-2 d-flex">
                    <a th:if="${session.loginUser!=null && session.loginUser.uId==c.user.uId}" th:href="@{'/comm/{cId}/modify.do'(cId=${c.cId})}"  class="btn btn-sm btn-outline-dark me-1">ÏàòÏ†ï</a>
                    <a th:if="${session.loginUser!=null && session.loginUser.uId==c.user.uId}" th:href="@{'/comm/{cId}/remove.do'(cId=${c.cId})}"  class="btn btn-sm btn-outline-danger">ÏÇ≠Ï†ú</a>
                </div>
            </div>
            <p class="text-end text-muted me-2">
                <small>ÏûëÏÑ±Ïùº: <span th:text="${#dates.format(c.postTime,'yyyy-MM-dd')}"></span></small>
                <small><i class="bi bi-eye"></i>Ï°∞ÌöåÏàò <span th:text="${c.viewCount}"></span></small>
            </p>
            <div class="card-body">
                <div th:id="'carousel'+${c.cId}" class="carousel slide" data-bs-ride="carousel">
                    <div th:if="${c.imgs != null}"  class="carousel-inner">
                        <div class="carousel-item" th:each="img,state:${c.imgs}" th:classappend="${(state.first)?'active':''}">
                            <img th:src="@{'{path}'(path=${img.imgPath})}" class="d-block w-100" alt="Í≤åÏãúÍ∏Ä Ïù¥ÎØ∏ÏßÄ">
                        </div>
                    </div>
                    <div th:unless="${c.imgs != null}" class="carousel-inner">
                        <div class="carousel-item">
                            <img src="/public/img/comm/1681717713661_1319.jpeg" class="d-block w-100 active" alt="Í∏∞Î≥∏Ïù¥ÎØ∏ÏßÄ">
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" th:data-bs-target="'#carousel'+${c.cId}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" th:data-bs-target="'#carousel'+${c.cId}" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>

            <div class="card-body">
                <h5 class="card-title" >ÏùºÏ†ï</h5>
                <th:block th:if="${c.user!=null}" th:each="plan,index:${c.user.plans}">
                    <th:block th:if="${plan.pId==c.pId}">
                        <th:block  th:each="p:${plan.contents}">
                            <div class="accordion accordion-flush" th:id="'accordionFlushExample'+${p.conId}">
                                <div class="accordion-item" >
                                    <h2 class="accordion-header">
                                        <button  class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:data-bs-target="'#flush-collapse-' + ${p.conId}"  aria-expanded="false" aria-controls="flush-collapseOne">
                                            <span th:text="${p.time}" class="text-bg-warning me-4 p-2  border-warning rounded-5"></span>
                                            <span th:text="${p.title}"></span>
                                        </button>
                                    </h2>
                                    <div th:id="'flush-collapse-' + ${p.conId}" class="accordion-collapse collapse"  th:data-bs-parent="'#accordionFlushExample'+${p.conId}" >
                                        <div class="accordion-body w-100">
                                            <div th:if="${p.imgPath!=null}" >
                                                <img th:src="@{'{path}'(path=${p.imgPath})}" class="img-fluid" alt="ÏùºÏ†ïÍæ∏ÎØ∏ÎäîÏù¥ÎØ∏ÏßÄ">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </th:block>
                    </th:block>
                </th:block>

                </div>
            </div>
            <hr>
            <div class="card-body d-flex justify-content-end align-items-center" >
                <div class="d-flex justify-content-end fs-3">
                    <div th:id="'likeCont'+${c.cId}"  th:with="likes=${c.likes},id=${c.cId}">
                        <th:block th:with="likes=${c.likes},cId=${c.cId}" th:include="/comm/Likes"> </th:block>
                    </div>
                    <div>
                    <a href="javascript:void(0)" id="myPlanAdd" th:onclick="registerPlan([[${c.pId}]])"><i class="bi bi-calendar-plus text-secondary me-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="ÎÇ¥ÏùºÏ†ïÎ∞îÎ°úÏ∂îÍ∞Ä"></i></a>
                    <a href="javascript:void(0)" th:if="${session.loginUser.uId!=c.uId}" th:onclick="registerBookMark([[${c.cId}]],[[${c.pId}]])"><i class="bi bi-bookmark-plus text-warning me-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Î∂ÅÎßàÌÅ¨"></i></a>
                    <a href="javascript:void(0)" th:unless="${session.loginUser.uId!=c.uId}" th:onclick="alert('Î≥∏Ïù∏Ïù¥ Ïì¥ Í∏ÄÏùÄ Ïã†Í≥†Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')"><i class="bi bi-bookmark-plus text-warning me-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Î∂ÅÎßàÌÅ¨"></i></a>
                    <a href="javascript:void(0)" id="commReport" ><i class="bi bi-bell-fill text-danger" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Ïã†Í≥†ÌïòÍ∏∞"></i></a>
                    </div>

                </div>

            </div>

            <div class="card-body me-4 fs-4 text-center ">
                <a  class="text-decoration-none text-muted" href="#contentPage" >ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ</a>
                <span>|</span>
                <a class="text-decoration-none text-muted" href="#repliesPage" >ÎçßÍ∏Ä</a>
            </div>

            <div class="card-body" id="contentPage">
                <p th:utext="${c.content}"> </p>
            </div>

            <!--ÎãµÍ∏Ä Íµ¨ÌòÑ-->
            <div class="card-body" id="repliesPage">
                <h5>ÎåìÍ∏Ä</h5>
                <div>
                    <ul class="list-group border-0"  id="replyCont">
                        <li class="list-group-item border-0" th:each="r:${c.getReplies()}" >
                            <!--ÎåìÍ∏ÄÎ¶¨Ïä§Ìä∏ ÏòÅÏó≠-->
                            <th:block th:include="/comm/reply/detail"></th:block>
                        </li>
                        <!--ÏùºÎ∞òÎåìÍ∏ÄÏûÖÎ†•ÏòÅÏó≠-->

                    </ul>
                    <div class="list-group-item border-0 bg-light " id="">
                        <form name="replyInsertForm"  action="" method="post"
                              onsubmit="event.preventDefault();registerReply(this);"
                        >
                            <input type="hidden" name="uId" th:value="${c.getUId()}">
                            <input type="hidden" name="cId" th:value="${c.cId}">
                            <div class="d-flex">
                                <div class="col-3 p-0">
                                    <input type="hidden" class="form-control" name="parentCrId"  >
                                    <input type="text" class="form-control" name="nkName" th:value="${(session.loginUser==null)?'':session.loginUser.nkName}"  >
                                </div>
                                <div class="col p-0">
                                    <input type="text" class="form-control" name="content" placeholder="ÎåìÍ∏ÄÎÇ¥Ïö©">
                                </div>
                                <button class="btn btn-secondary">Ï†úÏ∂ú</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        <div class="text-end">
            <a class="btn btn-outline-warning my-2" href="/comm/list.do"> Î™©Î°ùÏúºÎ°ú</a>
        </div>
        </div>

    <!--üòé Î™®Îã¨Ï∞Ω -->
    <th:block th:include="/comm/reportModal" th:with="uId=${c.getUId()},cId=${c.getCId()}"></th:block>
    <th:block th:include="/comm/profileModal"></th:block>


    <script>
        const reportModal=new bootstrap.Modal(document.getElementById('reportModal',{}));
        const profileModal=new bootstrap.Modal(document.getElementById('profileModal',{}));
        const profile=document.getElementsByClassName("profile");
        const commReport=document.getElementById("commReport");
        const myPlanAdd=document.getElementById("myPlanAdd");
        const bookMarkCheck=document.getElementById("bookMarkCheck");
        const replyContainer=document.getElementById("replyCont");
        const replyInsertForm=document.forms["replyInsertForm"];
        const replyReplyForm=document.forms["replyReplyForm"];

        //ÌîÑÎ°úÌïÑ ÌÅ¥Î¶≠Ïãú ÌîÑÎ°úÌïÑ Î™®Îã¨Ï∞ΩÎú∏
        Array.from(profile).forEach((p)=>{
            p.addEventListener("click",(e)=>{
                e.preventDefault();
             profileModal.show();
        })});
        //Ïã†Í≥†Í∏Ä ÌÅ¥Î¶≠Ïãú Î™®Îã¨Ï∞Ω
        commReport.addEventListener("click",(e)=>{
            reportModal.show();
        })



        async function loadReplies(cId){
            let url=`/comm/reply/${cId}/list.do`
            const resp=await fetch(url);
            if(resp.status===200){
                let text=await resp.text();
                replyContainer.innerHTML=text;
            }
        }


        async function registerReply(replyInsertForm){
            const data= new FormData(replyInsertForm);
            let url="/comm/reply/handler.do";
            const resp= await fetch(url,{method:"POST",body:data});
            if(resp.status===200){
                const json=await resp.json();
                if(json.handler>0){
                    alert("Îì±Î°ùÏÑ±Í≥µ!")
                    await loadReplies(replyInsertForm.cId.value);                }
            }else{
                alert("Îì±Î°ùÏã§Ìå®"+resp.status);
            }
        }



        async function modifyReply(modifyForm){//ÏàòÏ†ïÏù¥ ÏãúÏûëÎê†ÎñÑ Ìï∏Îì§Îü¨
            let url="/comm/reply/handler.do"
            const data=new FormData(modifyForm);
            const resp=await fetch(url,{method:"PUT",body:data});
            if(resp.status===200){
                const json=await resp.json();
                if(json.handler>0) {
                    alert("ÏàòÏ†ïÏÑ±Í≥µ!");
                    await loadReplies(replyInsertForm.cId.value);
                }
            }else{
                alert("ÏàòÏ†ïÌÜµÏã†Ïã§Ìå®");
            }
        }

        async function removeReply(replyNum) {
            let check = confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            let url = "/comm/reply/handler.do";
            const data=new FormData();
            data.set("ccId",replyNum);
            if (check) {
                const resp = await fetch(url, {method:"DELETE",body:data})
                if (resp.status === 200) {
                    const json = await resp.json();
                    if(json.handler>0){
                        alert("ÏÇ≠Ï†ú ÏÑ±Í≥µ");
                        await loadReplies(replyInsertForm.cId.value);
                  }
                }else{
                    alert("ÏÇ≠Ï†ú ÌÜµÏã† Ïã§Ìå® status: " + resp.status)
                }
            }
        }
    //Î∂ÅÎßàÌÅ¨ ÌÅ¥Î¶≠Ïãú Îì±Î°ù

     async function registerBookMark(cId,pId){
         let check=confirm("Î∂ÅÎßàÌÅ¨Î•º Îì±Î°ùÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
         let url="/bookmark/comm/"+cId+"/"+pId+"/handler.do";
         if(check){
             const resp= await fetch(url,{method:"POST"});
             if(resp.status===200){
                 const json=await resp.json();
                 if(json.handler>0) {
                     alert("Î∂ÅÎßàÌÅ¨ Îì±Î°ù ÏÑ±Í≥µ!");
                 }
             }else{
                 alert("Ïù¥ÎØ∏ Î∂ÅÎßàÌÅ¨Î•º ÌïòÏÖ®ÏäµÎãàÎã§!");
             }
         }
     }

     //ÎÇ¥ÏùºÏ†ï Ï∂îÍ∞Ä
        async function registerPlan(pId){
            let check=confirm("ÎÇ¥ ÏùºÏ†ïÏóê Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?")
            let url="/comm/plan/"+pId+"/handler.do";
            if(check){
                const resp= await fetch(url,{method:"POST"});
                if(resp.status===200){
                    const json=await resp.json();
                    if(json.handler>0) {
                        alert("ÏùºÏ†ï Îì±Î°ù ÏÑ±Í≥µ!");
                    }
                }else{
                    alert("Ïù¥ÎØ∏ Îì±Î°ùÌïú ÏùºÏ†ïÏûÖÎãàÎã§.!");
                }
            }
        }

    </script>
</div>
</html>