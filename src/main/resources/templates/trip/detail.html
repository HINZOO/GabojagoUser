<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout}">
<head>
    <meta charset="UTF-8">
    <title>ÎßûÏ∂§Ï∂îÏ≤ú Î¶¨Ïä§Ìä∏</title>
    <script src=""></script>
    <style>
        .delImgInput {
            display: none;
        }
        .delImgItem > .delImgInput:checked + img {
            background-color: lightcoral;
        }
    </style>
</head>
<div layout:fragment="content" class="container">
<!--    <script src="/public/js/splideTest.js"></script>-->
    <h3 class="my-4">ÎßûÏ∂§Ï∂îÏ≤ú ÏÉÅÏÑ∏</h3>

    <!--    <div class="splide">-->
    <!--        <div class="splide__track">-->
    <!--            <ul class="splide__list">-->
    <!--                <li class="splide__slide"><img src="image1.jpg"></li>-->
    <!--                <li class="splide__slide"><img src="image2.jpg"></li>-->
    <!--                <li class="splide__slide"><img src="image3.jpg"></li>-->
    <!--            </ul>-->
    <!--        </div>-->
    <!--    </div>-->

    <section id="tripCont">
        <div class="row">
            <div class="col-5">
                <div class="card border-dark border-opacity-25">
                    <div class="card-header p-3 bg-transparent border-dark border-opacity-25">
                        <div class="d-flex justify-content-around">
                            <p class="card-text d-flex flex-column align-items-center g-2 mb-0">
                                <span class="bi bi-heart mb-1"></span>
                                Ï¢ãÏïÑÏöî
                                <span>156</span>
                            </p>
                            <p class="card-text d-flex flex-column align-items-center g-2 mb-0">
                                <span class="bi bi-heart mb-1"></span>
                                Î∂ÅÎßàÌÅ¨
                                <span>156</span>
                            </p>
                            <p class="card-text d-flex flex-column align-items-center g-2 mb-0">
                                <span class="bi bi-heart mb-1"></span>
                                Î¶¨Î∑∞
                                <span>156</span>
                            </p>
                            <p class="card-text d-flex flex-column align-items-center g-2 mb-0">
                                <span class="bi bi-heart mb-1"></span>
                                Î∞©Î¨∏
                                <span>156</span>
                            </p>
                            <p class="card-text d-flex flex-column align-items-center g-2 mb-0">
                                <span class="bi bi-heart mb-1"></span>
                                Ï°∞ÌöåÏàò
                                <span>156</span>
                            </p>
                        </div>
                    </div> <!-- // Ï¢ãÏïÑÏöî,Î∂ÅÎßàÌÅ¨,Î¶¨Î∑∞,Î∞©Î¨∏,Ï°∞ÌöåÏàò -->

                    <div class="card-body text-success">
                        <h5 class="card-title">Ï†úÏ£ºÎèÑÏóêÏÑú Ï¶êÍ∏∞Îäî Î¥ÑÍΩÉ Ïó¨Ìñâ</h5>
                        <p class="card-text">
                            <span>‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
                            <small>156</small>
                        </p>
                        <p class="card-text">
                            #enfj#enfp#istj
                            mbti / Ìï¥ÏãúÌÉúÍ∑∏
                        </p>
                        <h6>Í∏∞Î≥∏Ï†ïÎ≥¥</h6>
                        <p class="card-text">
                            Ï£ºÏÜå
                            <span>ÏÑúÍ∑ÄÌè¨</span>
                        </p>
                        <p class="card-text">
                            Ïó∞ÎùΩÏ≤ò
                            <span>01011112222</span>
                        </p>
                        <p class="card-text">
                            ÌôàÌéòÏù¥ÏßÄ
                            <span>https://www.visitjeju.net/kr/</span>
                        </p>
                        <p class="card-text">
                            Îì±Î°ùÏùº / ÏàòÏ†ïÏùº
                            <span></span>
                        </p>
                    </div> <!---->

                    <div class="card-footer bg-transparent border-dark border-opacity-25">
                        <label for="" class="form-label">ÏÜåÍ∞úÍ∏Ä</label>
                        <textarea name="" id="" rows="4" class="form-control" th:text="${t.content}"></textarea>
                    </div>
                </div>
            </div> <!-- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ (ÏôºÏ™Ω) -->


            <div class="col-7">
                <div class="card mb-3" style="border:none; height:80vh; overflow-y: auto">
<!--                    <div class="card-header d-flex justify-content-between align-items-center">-->
<!--                        <strong th:text="${t.area}"></strong>-->
<!--                        <i class="bi bi-heart text-danger"></i>-->
<!--                    </div>-->

                    <!-- imgs Í∞Ä null Ïù¥ ÏïÑÎãàÎ©¥ Î≥¥Ïù¥Í∏∞! null Ïù¥Î©¥ ÏïàÎ≥¥Ïù¥Í∏∞! -->
                    <div th:id="'carousel'+${t.tId}" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item rounded-top overflow-hidden" th:each="img,state : ${t.imgs}"
                                 th:classappend="${img.imgMain}?'active':''">
                                <img th:if="${t.imgs!=null}" th:src="@{'{path}'(path=${img.imgPath})}"
                                     class="d-block w-100" style="object-fit: contain">
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" th:data-bs-target="'#carousel'+${t.tId}"
                                data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" th:data-bs-target="'#carousel'+${t.tId}"
                                data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    <div class="pt-3">
                        <p class="d-flex justify-content-between align-items-center">
                            <span>
                                Ïó¨ÌñâÍ∞ÄÏùò Î¶¨Î∑∞ <strong>52</strong>
                            </span>
                            <a class="btn btn-danger" href="javascript:void(0)" id="loadReviewRegister">
                                Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞
                            </a>
                        </p>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="mb-0">
                                <span>
                                    <i class="bi bi-record-circle text-danger"></i>
                                    Ï¢ãÏïÑÏöîÏàú
                                </span>
                                <span>
                                    <i class="bi bi-circle text-dark text-opacity-25"></i>
                                    ÏµúÏã†Ïàú
                                </span>
                            </p>
                            <button type="button" class="btn btn-light" th:onclick="loadReviews([[${t.tId}]])">
                                ÏÉàÎ°úÍ≥†Ïπ®
                            </button>
                        </div>
                        <hr>
                        <div id="reviewCont">
                            <ul class="list-group">
                                <li class="list-group-item" th:each="r:${t.reviews}">
<!--                                    <span th:text="${r}"></span>-->
                                    <th:block th:include="/trip/review/detail.html"></th:block>
                                </li>
                            </ul>
                        </div> <!-- // reviewCont -->
                    </div>

                    <div class="card-footer position-sticky bottom-0 bg-light" style="border: 1px solid #ddd;">
                        <!-- Î¶¨Î∑∞ÎåìÍ∏Ä ÏûÖÎ†•Ìèº -->
                        <form enctype="multipart/form-data" name="reviewCmtInsertForm" method="post" action="">
                            <div class="row align-items-center">
                                <input type="hidden" name="uId" th:value="${session.loginUser.uId}">
                                <input type="hidden" name="tId" th:value="${t.tId}">
                                <div class="col-2">
                                    <input name="trId" placeholder="Î¶¨Î∑∞ÎåìÍ∏Ä" type="text" readonly class="form-control">
                                </div>
                                <div class="col-2">
                                    <input name="parentTrcId" placeholder="Î∂ÄÎ™®ÎåìÍ∏Ä" type="text" readonly class="form-control">
                                </div>
                                <div class="col">
                                    <input name="content" placeholder="ÎåìÍ∏ÄÎã¨Í∏∞..." type="text" class="form-control">
                                </div>
                                <button class="btn col-auto">
                                    <i class="bi bi-send"></i>
                                    <!-- Îì±Î°ù -->
                                </button>
                                <label class="col-auto">
                                    <i class="bi bi-file-image"></i>
                                    <input class="d-none" type="file" name="img">
                                </label>

                            </div>
                        </form>
                    </div>


                </div>
                <!-- Î¶¨Î∑∞ÏûëÏÑ±ÌïòÍ∏∞ Modal -->
                <th:block th:include="/trip/review/reviewRegisterModal.html"></th:block>

            </div> <!-- Ïò§Î•∏Ï™Ω Í∑∏Î¶¨Îìú -->
        </div> <!-- // Í∑∏Î¶¨Îìú row -->
    </section>
    <script> 
    // Î¶¨Î∑∞Îì±Î°ù Î™®Îã¨Ï∞Ω Ïù¥ÎØ∏ÏßÄ Î≤ÑÌäº
    const registerImgAddBtn = document.getElementById("registerImgAddBtn");
    if(registerImgAddBtn){ // // üëÄ Ìï®Ïàò ÏúÑÏπòÍ∞Ä Îã¨ÎùºÏÑú ? if Î¨∏ Ìï¥Ï£ºÎäîÍ±∞? register Ìï®Ïàò ÏïÑÎûòÏóê ÏûàÏúºÎ©¥ if ÏïàÌï¥Ï§òÎèÑ ÎêòÎÇò?
        const registerImgCont = document.getElementById("registerImgCont");
        let registerImgAddBtnCount = 0;
        registerImgAddBtn.addEventListener("click", (e) => {
            if (registerImgAddBtnCount < 5) {
                registerImgCont.insertAdjacentHTML("beforeend", registerImgInputComponent());
                registerImgAddBtnCount++;
            }
        });

        function registerImgInputComponent(label = "Ïù¥ÎØ∏ÏßÄ", name = "img") {
            return `
                     <p class="input-group mt-2">
                        <label class="input-group-text click">${label}</label>
                        <input class="form-control" type="file" name="${name}">

                        <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </p>
                `
        }
    }

    // Î¶¨Î∑∞ ÏàòÏ†ïÎ™®Îã¨
    const modifyImgAddBtn = document.getElementById("modifyImgAddBtn");
    if(modifyImgAddBtn){ // üëÄ if(reviewModifyModal) Ïù¥ÏïàÏóê ÏûàÏñ¥ÎèÑ ÎêòÎäîÍ≤É? Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Îã¨ÎùºÏÑú?
        const modifyImgCont = document.getElementById("modifyImgCont");
        let modifyImgAddBtnCount = 0;
        modifyImgAddBtn.addEventListener("click", (e) => {
            if (modifyImgAddBtnCount < 5) {
                modifyImgCont.insertAdjacentHTML("beforeend", modifyImgInputComponent());
                modifyImgAddBtnCount++;
            }
        });

        function modifyImgInputComponent(label = "Ïù¥ÎØ∏ÏßÄ", name = "img") {
            return `
                     <p class="input-group mt-2">
                        <label class="input-group-text click">${label}</label>
                        <input class="form-control" type="file" name="${name}">

                        <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </p>
                `
        }
    }
    </script>
    <script th:inline="javascript">
        const reviewRegisterModal = new bootstrap.Modal(document.getElementById("reviewRegisterModal"), {}); // {} Ïù¥Í≤å Î≠êÏßÄ?
        let reviewModifyModal;

        if(document.getElementById("reviewModifyModal")){
            reviewModifyModal=new bootstrap.Modal(document.getElementById("reviewModifyModal"),{})
        }
        const reviewRegisterForm = document.forms["reviewRegisterForm"];
        const reviewModifyForm=document.forms["reviewModifyForm"];
        const reviewCmtInsertForm=document.forms["reviewCmtInsertForm"];
        const reviewCont = document.getElementById("reviewCont");
        const removeReviewBtn=document.getElementById("removeReviewBtn");


            removeReviewBtn.addEventListener("click",removeReview);
        if(removeReviewBtn){ // üëÄ if(reviewModifyModal) ÏïàÏóê ÏûàÏñ¥ÎèÑ ÎêòÎÇò?
        }

        // Î¶¨Î∑∞ Îì±Î°ù Î≤ÑÌäº => Î¶¨Î∑∞Îì±Î°ù Î™®Îã¨Ï∞Ω Î≥¥Ïù¥Í∏∞
        const loadReviewRegister=document.getElementById("loadReviewRegister");
        loadReviewRegister.addEventListener("click",function(){
            reviewRegisterModal.show();
        });
        if(reviewModifyModal){ // üëÄ if(reviewModifyModal) ÌïòÎÇòÎ°ú Ìï©ÏπòÎäîÍ±¥ ?
            async function removeReview(){
                let c = confirm("ÏÇ≠Ï†ú ÌïòÏãúÍ≤†ÏäµÎãàÍπå"); // ÏÇ≠Ï†ú ÏïåÎ¶ºÏ∞Ω (ÌôïÏù∏ true / Ï∑®ÏÜå false)
                let url="/review/handler.do";
                let data=new FormData(reviewModifyForm);
                if(c) { // ÏÇ≠Ï†ú ÌôïÏù∏Î≤ÑÌäº
                    const resp=await fetch(url, {method:"DELETE", body:data});
                    if(resp.status===200){
                        const json=await resp.json(); // json Í∞ùÏ≤¥
                        if(json.remove>0){
                            alert("ÏÇ≠Ï†ú ÏÑ±Í≥µ");
                            loadReviews(reviewModifyForm.tId.value);
                        } else{
                            alert("ÏÇ≠Ï†ú Ïã§Ìå®(ÏÇ≠Ï†úÎêú Î†àÏΩîÎìú)");
                        }
                    } else { // Ïò§Î•òÎ∞úÏÉù
                        alert("ÏÇ≠Ï†úÏã§Ìå® status : " + resp.status);
                    }
                }
                reviewModifyModal.hide();
            }

        }
        // Î¶¨Î∑∞ ÏÇ≠Ï†ú Î≤ÑÌäº

        // ÎåìÍ∏ÄÎã¨Í∏∞ ÌÅ¥Î¶≠ Ïãú, input Ïóê value Í∞í(ÌååÎùºÎØ∏ÌÑ∞Î°ú ÎÑòÍ∏∞Îäî Í∞í) Îã¥Îäî Ìï®Ïàò
        function reviewCmtClick(trId,trcId){
            reviewCmtInsertForm.trId.value=trId;
            reviewCmtInsertForm.parentTrcId.value=trcId;
        }

        async function loadReviewsCmt(trId){
            let url=`/reviewcmt/${trId}/list.do`
            const resp=await fetch(url);
            if(resp.status===200){
                let text=await resp.text();
                reviewCont.innerHTML=text; // ajax Î°ú Î¶¨Ïä§Ìä∏ ÏÉàÎ°ú Î∂àÎü¨Ïò§Í∏∞
                // console.log(text);
                // alert("Î≥ÄÍ≤Ω");
            }
        }


        reviewCmtInsertForm.onsubmit=registerReviewCmt;
        async function registerReviewCmt(e){
            e.preventDefault();
            const data = new FormData(reviewCmtInsertForm);
            let url="/reviewcmt/handler.do"
            const resp=await fetch(url,{method:"POST", body:data});
            if(resp.status===200){
                const json=await resp.json();
                if(json.register>0){
                    alert("Îì±Î°ùÏÑ±Í≥µ");
                    await loadReviews(reviewCmtInsertForm.tId.value);
                    // loadReviews(reviewModifyForm.tId.value);
                    // await loadReviewsCmt(reviewCmtInsertForm.trId.value);
                }
            }else{
                alert("Îì±Î°ùÏã§Ìå® status:" + resp.status);
            }

        }
        if(reviewModifyModal){
            async function loadModifyReview(trId){
                let url=`/review/${trId}/detail.do`;
                const resp= await fetch(url);
                if(resp.status===200){
                    const json=await resp.json();
                    console.log(json)
                    // input Ïùò Ïù¥Î¶Ñ name => key Í∞í
                    // {"trId":19,"content":"dddd Ïù¥ÎØ∏ÏßÄ Îì±Î°ù ÏÇ≠Ï†ú ÌÖåÏä§Ìä∏","visit":false,"postTime":"2023-04-20T23:05:13.000+00:00","updateTime":"2023-04-23T04:28:37.000+00:00","grade":0,"imgs":[{"triId":6,"trId":19,"imgPath":"ÌÖåÏä§Ìä∏"},{"triId":43,"trId":19,"imgPath":"/public/img/trip/review/1682224117423_27386.jpeg"}],"user":{"pw":"1234","name":"ÍπÄÏ≤†Ïàò","nkName":"Î∞îÎ≥¥Ï≤†Ïàò","email":"user01@example.com","birth":"1989-12-31T15:00:00.000+00:00","phone":"010-1234-5678","address":"ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨","detailAddress":"ÏÇºÏÑ±Îèô 123-45","prContent":"ÏïàÎÖïÌïòÏÑ∏Ïöî. Ï†ÄÎäî Ï≤†ÏàòÏûÖÎãàÎã§.","permission":"USER","mbti":"ISTJ","imgPath":"/public/img/trip/review/jeju1.jpeg","postTime":"2023-04-19T03:19:22.000+00:00","storeName":null,"businessId":null,"uid":"USER01"},"tId":1,"uId":"user01"}
                    reviewModifyForm.querySelectorAll("[name]").forEach((input)=>{
                        let key=input.name;
                        if(key in json) {
                            if(key==="imgPath"){
                                input.src=json[key];
                            }
                            else{
                                input.value=json[key];
                            }
                        }
                    })
                    reviewModifyModal.show();
                } else{
                    alert("Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå® status: " + resp.status);
                }
            }

        }


        reviewRegisterForm.onsubmit = registerReview;
        async function registerReview(e) {
            e.preventDefault(); // ajax => form Ïóê Î≤ÑÌäº submit Ïù¥Î≤§Ìä∏ ÎßâÍ∏∞
            reviewRegisterModal.hide();
            let url = "/review/handler.do"
            const data = new FormData(reviewRegisterForm);
            const resp = await fetch(url, {method: "POST", body: data});
            if (resp.status===200) {
                const json = await resp.json(); // ÏùëÎãµÍ∞ùÏ≤¥ json Í∞ùÏ≤¥Î°ú ÌååÏã±
                if (json.register > 0) {
                    alert("Îì±Î°ùÏÑ±Í≥µ");
                    await loadReviews(reviewRegisterForm.tId.value);
                }
                console.log(json);
            } else {
                alert("Îì±Î°ùÏã§Ìå® status: " + resp.status);
            }
        }
        if(reviewModifyModal){
            reviewModifyForm.onsubmit=modifyReview;
            async function modifyReview(e) {
                e.preventDefault();
                reviewModifyModal.hide();
                let url="/review/handler.do";
                const data=new FormData(reviewModifyForm);
                const resp=await fetch(url,{method:"PUT", body:data});
                if(resp.status===200){
                    const json=await resp.json();
                    if(json.modify>0) {
                        alert("ÏàòÏ†ïÏÑ±Í≥µ");
                        loadReviews(reviewModifyForm.tId.value);
                    }
                }else{
                    alert("ÏàòÏ†ï Ïã§Ìå® status : " + resp.status);
                }
            }
        }

        async function loadReviews(tId){
            let url=`/review/${tId}/list.do`
            const resp=await fetch(url);
            if(resp.status===200){
                let text=await resp.text();
                reviewCont.innerHTML=text; // ajax Î°ú Î¶¨Ïä§Ìä∏ ÏÉàÎ°ú Î∂àÎü¨Ïò§Í∏∞
                // console.log(text);
                // alert("Î≥ÄÍ≤Ω");
            }
        }




    </script>


</div>
</html>