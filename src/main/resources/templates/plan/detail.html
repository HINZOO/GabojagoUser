<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>게시판 상세</title>
    <link th:href="@{/public/css/plan/plan.css}" rel="stylesheet" />
</head>

<div layout:fragment="content" class="container-fluid px-0">
        <div class="row">

            <!--    사이드바 -->
            <div class="col-md-2" ></div>

            <div class="col-md-8 mainSection px-0">
                <div class="row mainHeader px-0 ">
                    <img class="mainHeaderImg mx-0 px-0" src="/public/img/plan/planSample2.jpg">
                    <div class="col-6 titleBox">
                        <div class="titleInnerBox">
                            <p class="headerTitle" th:text="${plan.getTitle()}"/>
                            <span class="headerFrom" th:text="${plan.getPlanFrom()}"/> ~ <span class="headerTo" th:text="${plan.getPlanTo()}"/>
                            <p class="headerStatus" th:text="${plan.getPlanStatus()}"/>
                        </div>
                    </div>
                    <div class="col-6 rightBox">
                        <div class="toDoListBox">
                            <div class="tdlTitle">
                                <span>CHECKLIST</span>
                                <span><span class="tdlPBtn" th:onclick="'tdlInsert('+${plan.getPId()}+')'" style="margin-right: 5px">+</span></span>
                            </div>

                            <div class="tdlContent">
                                <th:block th:each="checkList:${plan.getCheckLists()}">
<!--                                    <span th:text="${checkList}"></span>-->
                                <form class="tdlform px-0">
                                    <input name="clId" th:value="${checkList.getClId()}" style="display: none">
                                    <input name="pId" th:value="${plan.getPId()}" style="display: none" readonly>
                                    <input type="checkbox" class="tdlCheck" name="checkStatus" th:value="${checkList.getCheckStatus()}" th:id="'tdlCheck_'+${checkList.getClId()}"  onclick=tdlModify(this) th:if="${checkList.getCheckStatus()=='CHECKED'}" checked>
                                    <input type="checkbox" class="tdlCheck" name="checkStatus" th:value="${checkList.getCheckStatus()}" th:id="'tdlCheck_'+${checkList.getClId()}"  onclick=tdlModify(this) th:if="${checkList.getCheckStatus()=='UNCHECKED'}">
                                    <label class="tdlCheckLabel p-0" th:for="'tdlCheck_'+${checkList.getClId()}"></label>
                                    <input type="text" class="tdlInput" th:classappend="${checkList.getCheckStatus()} == 'CHECKED' ? 'textCancel'" th:value="${checkList.getContent()}" name="content">
                                    <i class="bi bi-check-circle tdlSubmit" onclick=talRegistry(this) style="display: none"></i>
                                    <span onclick=tdlDelete(this)><span class="tdlMBtn tdlDelete">-</span></span>
                                </form>
                                </th:block>
                            </div>
                        </div>

                    </div>
                </div>

                >
                <div class="row">
                    <div class="col-12 scheduleHeader">
                    <div class="row">
                    <div class="col-md-2">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary btn-lg dropdown-toggle dayBtn py-0 border-0" data-bs-toggle="dropdown" aria-expanded="false">
                                Day 01
                            </button>
                            <ul class="dropdown-menu p-0 border-0" style="text-align: center">
                                <li><a class="dropdown-item dayBtn mx-0" style="color: white" href="#">DAY 02</a></li>
                                <li><a class="dropdown-item dayBtn mx-0" style="color: white" href="#">DAY 03</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="btn-group btn-group-horizon btnLine" role="group">
                            <!--이미지 삽입-->
                            <button class="btn-group"  type="button" id="imgBtn">
                                <i class="bi bi-image"></i>
                                <input id="imgInput" type="file" style="display: none"/>
                            </button>
                            <!--보관함-->
                            <button class="btn-group"  type="button" id="loadBtn">
                                <i class="bi bi-folder2-open"></i>
                            </button>
                            <!-- 지우기 -->
                            <button class="btn-group"  type="button"  id="removeBtn">
                                <i class="bi bi-trash"></i>
                            </button>
                            <!--선택-->
                            <button class="btn-group" type="button" id="selectorBtn">
                                <i class="bi bi-hand-index"></i>
                            </button>
                            <!--이동-->
                            <button class="btn-group" type="button"  id="moveBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-arrows-move"></i>
                            </button>
                            <!--펜-->
                            <button class="btn-group"  type="button" id="penBtn">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <!--직선-->
                            <button class="btn-group"  type="button" id="lineBtn" >
                                <i class="bi bi-slash-lg"></i>
                            </button>
                            <!--박스 -->
                            <button class="btn-group"  type="button"  id="rectBtn">
                                <i class="bi bi-square"></i>
                            </button>
                            <!--텍스트입력-->
                            <button class="btn-group" type="button"  id="textBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-fonts"></i>
                            </button>
                            <!--파레트-->
                            <button class="btn-group"  type="button"   id="palateBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-palette"></i>
                            </button>
                            <!--포스트잇-->
                            <button class="btn-group"  type="button"  id="postBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-sticky"></i>
                            </button>
                            <!--스템프-->
                            <button class="btn-group"  type="button" id="stampBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-star"></i>
                            </button>
                            <!--설정-->
                            <button class="btn-group"  type="button"  id="settingBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-gear"></i>
                            </button>
                            <!--플러스버튼-->
                            <button class="btn-group"  type="button"  id="plusBtn">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                            <!--마이너스버튼-->
                            <button class="btn-group"  type="button"  id="minusBtn">
                                <i class="bi bi-dash-circle"></i>
                            </button>
                            <button class="btn-group" id="red" ></button>
                            <button class="btn-group" id="orange"></button>
                            <button class="btn-group" id="yellow"></button>
                            <button class="btn-group" id="green"></button>
                            <button class="btn-group" id="blue"></button>
                            <button class="btn-group" id="navy"></button>
                            <button class="btn-group" id="purple"></button>
                            <button class="btn-group" id="black"></button>
                            <button class="btn-group" id="white"></button>

                            </div><!--버튼그룹닫기-->
                        </div> <!--col 9-->

                    <div class="col-md-2 scheduleInputBox">
                        <div id="newScheduleBtn">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                    </div>
                    </div> <!--내부로우 수정필요-->

                </div> <!--스케쥴헤더-->



                    <div class="accordion .accordion-flush" id="accordionSection">
                        <div class="accordion-item" th:each="content:${plan.getContents()}">
                            <th:block th:include="/plan/contents"></th:block>
                        </div>
                    </div>

            </div> <!--메인섹션닫기-->

            <div class="col-md-2" ></div>

<!--            <div class="col-md-2">-->
<!--                <div class="row row-cols-1 sideGrid">-->
<!--                  <div class="col addBox">-->

<!--                  </div>-->
<!--                </div>-->
<!--            </div> &lt;!&ndash;우측사이드 닫기&ndash;&gt;-->




    </div> <!--그리드 row 닫기-->

<!--새 플랜 모달 부분-->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary bg-opacity-10">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">새 스케쥴 작성</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form  method="post" id="scheduleInsertForm">
                        <div class="row">
                            <div class="col-6">
                                <div class="row">
                                    <input type="text" class="form-control" name="pId" th:value="${plan.getPId()}"  id="floatingId" placeholder="" hidden>
                                    <input type="text" class="form-control" name="tId" value="" id="tId" placeholder="" hidden>
                                    <input type="text" class="form-control" name="sId" value="" id="sId" placeholder="" hidden>

                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="title" id="floatingTitle" placeholder="">
                                            <label for="floatingTitle">여행지</label>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="form-floating">
                                            <input type="time" class="form-control" name="sTime" id="sTime" placeholder="">
                                            <label for="sTime">시작시간</label>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="form-floating">
                                            <input type="time" class="form-control" name="eTime" id="eTime" placeholder="" value="">
                                            <label for="eTime">끝시간</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="info" id="info" placeholder="">
                                            <label for="info">경유지 & 메모</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="" class="form-control" name="" id="floatingImg" placeholder="">
                                    <label for="floatingImg">북마크넣을부분</label>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">만들기</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
            <!--      채팅방      -->
            <i class="bi bi-chat-dots-fill chatBtn" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling"></i>
            <th:block th:include="/plan/chatting"></th:block>

    <script th:inline="javascript">
        let activatedCanvas;
        let canvasMap=new Map();


        document.getElementById("imgBtn").addEventListener("mousedown",()=>{
            console.log(canvasMap.get(1));
            let input = document.getElementById("imgInput")
            input.click();
            input.addEventListener("change",async (e)=>{
                let data = new FormData()
                data.append("img",input.files[0])
                let url =`/plan/contents/imgHandler.do`
                const resp = await fetch(url,{method:"POST",body:data});
            },{once:true})
        })


        /*
        게시글을 로드 할 때 화면 초기화
        스케쥴이 추가되고 그림판까지 만든 경우와, 그림판은 만들지 않은 경우를 구분하여 처리
         */
        document.addEventListener("DOMContentLoaded",()=>{
            let initArr=[];
            let nBtns = document.querySelectorAll(".newCanvasBtn");
            [# th:each="c,s:${plan.getContents()}"]
            if([[${c.getPath()}]]!=null) initArr.push([[${c.getPath()}]])
            [/];
            initArr.forEach((a)=>{
               let ele = document.querySelector(`#content_${a.conId}`).lastElementChild;
                // console.log(a.pathId)
                newCanvas(ele,a.pathId,a.canPath);

            });
        });


        // 새 스케쥴 생성하는 경우
        const newScheduleBtn = document.querySelector("#newScheduleBtn");
        const newScheduleBtnM = new bootstrap.Modal(document.getElementById('staticBackdrop'),{});
        newScheduleBtn.addEventListener("click",()=>{
            newScheduleBtnM.show();
        });

        const scheduleInsertForm = document.getElementById("scheduleInsertForm");
        scheduleInsertForm.onsubmit=registerSchedule;

        async function registerSchedule(e){
            e.preventDefault();
            const data=new FormData(scheduleInsertForm);
            let sTime = !data.get("sTime") ? "--:--" : data.get("sTime");
            let eTime = !data.get("eTime") ? "--:--" : data.get("eTime");
            data.append("time", sTime + " ~ " + eTime)

            let url="/plan/contents/insert.do"
            const resp=await fetch(url,{method:"POST",body:data});
            if(resp.status===200){
                const json=await resp.json();
                document.getElementById("accordionSection").insertAdjacentHTML("beforeend",accordionInsert(json.conId,json.time,json.title,json.info))
                newScheduleBtnM.hide();
            }else {
                alert("등록 실패 status :"+resp.status);
            }
        }

        // 스케쥴 수정.삭제 버튼
        Array.from(document.getElementsByClassName("scheduleSideBtn2")).forEach((ele)=>{
            let conId
            ele.addEventListener("click",()=>{

            })
        })



        // 화이트보드를 추가 하는 경우
        async function newCanvasReg(ele){
            let conId = ele.parentElement.getAttribute("id").split("_")[1]
            let data = new FormData();
            data.set("conId",conId)
            let url =`/plan/contents/canvasHandler.do`
            const resp = await fetch(url,{method:"POST",body:data});
            const result = await resp.json();

            if(resp.status===200){
                newCanvas(ele, result.pathId);
            }else {
                alert("캔버스 생성 실패 status :"+resp.status);
            }
        }

        // 화이트보드 삭제하는 경우
        async function newCanvasDel(ele){
            let body = ele.nextElementSibling;
            let [btn, canvas] = body.children;
            let pathId = canvas.getAttribute("id")
            let url =`/plan/contents/canvasHandler.do`
            const resp = await fetch(url,{method:"DELETE",body:pathId});
            const result = await resp.json();
            if(resp.status===200 && result===1){
                canvas.remove();
                btn.style.display="block"
                body.style.height="130px"
            }else {
                alert("캔버스 삭제 실패 status :"+resp.status);
            }
        }

        // 체크리스트 폼 생성 하는 경우
        function tdlInsert(pId){
            let num = Math.floor(Math.random() * 101);
            let tdlCon = document.querySelector(".tdlContent")
            tdlCon.insertAdjacentHTML("beforeend",
                `<form class="tdlform px-0">
                    <input name="clId" style="display: none" disabled>
                    <input name="pId" value="${pId}" style="display: none" readOnly>
                    <input type="checkbox" class="tdlCheck" value="UNCHECKED" id="tdlCheck+${num}" name="checkStatus" onclick=tdlModify(this)>
                    <label class="tdlCheckLabel p-0" For="tdlCheck+${num}"></label>
                    <input type="text" class="tdlInput" placeholder="" name="content">
                    <i class="bi bi-check-circle tdlSubmit" onClick=talRegistry(this)></i>
                    <span style="display: none" onclick="tdlDelete(this)"><span class="tdlMBtn tdlDelete">-</span></span>
                </form>`
            )
        }

        // 체크리스트 등록 하는 경우
        async function talRegistry(ele){
            const form = ele.parentElement;
            const data = new FormData(form)
            data.set("checkStatus",ele.parentElement["checkStatus"].getAttribute("value"))
            let url ='/plan/tdlHandler.do'
            const resp = await fetch(url,{method:"POST",body:data});
            const result = await resp.json();
            if(resp.status===200){
                ele.style.display="none";
                form["clId"].setAttribute("value",result.clId);
                form["clId"].disabled=false;
                ele.previousElementSibling.readOnly=true;
                ele.nextElementSibling.style.display="inline";
            }else {
                form.remove();
                alert("체크리스트 등록 실패 status :"+resp.status);
            }
        }
        // 체크리스트 상태 수정 하는 경우
        async function tdlModify(ele){
            const form = ele.parentElement;
            const data = new FormData(form)
            data.set("checkStatus",ele.getAttribute("value"))
            let url ='/plan/tdlHandler.do'
            const resp = await fetch(url,{method:"PUT",body:data});
            const result = await resp.json();
            console.log(result)
            if(resp.status===200){
                ele.setAttribute("value",result.checkStatus);
                if(result.checkStatus==="CHECKED"){
                    ele.checked=true;
                    form["content"].classList.add("textCancel")
                } else if (result.checkStatus==="UNCHECKED") {
                    ele.checked=false;
                    form["content"].classList.remove("textCancel")
                }
            }else {
                alert("체크리스트 수정 실패 status :"+resp.status);
            }
        }

        // 체크리스트 삭제 하는 경우
        async function tdlDelete(ele){
            let url ='/plan/tdlHandler.do'
            const resp = await fetch(url,{method:"DELETE",body:ele.parentElement["clId"].getAttribute("value")});
            const result = await resp.json();
            if(resp.status===200 && result===1){
                ele.parentElement.remove();
            }else {
                alert("체크리스트 삭제 실패 status :"+resp.status);
            }
        }


        // 캔버스 인스턴스 생성용
        function newCanvas(ele,pathId,path=null){
            let w = document.querySelector(".accordion-item").clientWidth;
            let h = 500/1200*w+16; //16은 부트스트랩 아코디언바디에 설정된 상하 패딩값을 보정해준 것
            ele.style.height = h +"px";
            let newCanvas = new CanvasCreate(pathId, path);
            let canvas = newCanvas.canvas;
            canvas.setAttribute("id",pathId)
            ele.lastElementChild.style.display = "none"
            ele.append(canvas);
            canvasMap.set(pathId,newCanvas);
        }

        function accordionInsert(conId, time, title, info){
            return `<div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed scheduleBtn" type="button" data-bs-toggle="collapse"
                           data-bs-target="#content_${conId}" aria-expanded="false" aria-controls="#content_${conId}">
                             <div class="scheduleTime">${time}</div>
                              <div class="scheduleLeft"><br><i class="bi bi-three-dots-vertical"></i></div>
                              <div class="scheduleContainer">
                                  <p class="scheduleCenter">
                                      <span class="scheduleTitle">${title}</span>
                                      <span class="scheduleContent">${info}</span>
                                  </p>
                              </div>
                          </button>
                        </h2>
                        <div id="content_${conId}" class="accordion-collapse collapse " data-bs-parent="#accordionSection">
                            <p class="scheduleSideBtn1 sbHover"><i class="bi bi-three-dots"></i></p>
                            <p class="scheduleSideBtn2 sbHover" onclick=newCanvasDel(this)><i class="bi bi-trash3"></i></p>
                            <div class="accordion-body">
                                <p class="newCanvasBtn" onclick=newCanvasReg(this.parentElement)><i class="bi bi-plus-circle"></i></p>
                            </div>
                        </div>
                    </div>`;
        }




    </script>

    <script type="text/javascript" th:src="@{/public/js/plan/canvasFunction.js}"></script>
</div> <!--레이아웃 닫기-->
</html>

