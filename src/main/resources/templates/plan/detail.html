<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Í≤åÏãúÌåê ÏÉÅÏÑ∏</title>
    <link th:href="@{/public/css/plan/plan.css}" rel="stylesheet" />

</head>

<div layout:fragment="content" class="container-fluid px-0">
        <div class="row">

            <!--    ÏÇ¨Ïù¥ÎìúÎ∞î -->
            <div class="col-md-2" >
                <div class="row row-cols-1 sideGrid">
                    <div class="col titleBox">
                        <span th:text="${plan.getTitle()}"/>
                    </div>
                    <div class="col calenderBox">
                        <th:block th:include="/plan/calender"></th:block>
                    </div>

                    <div class="col infoBox">
                            <!--   <div class="infoImg" th:if="${plan.getImgPath()!=null}" th:style="'background-image:url(' +  + ');'"></div>-->
                            <img class="infoImg" th:if="${plan.getImgPath()!=null}" th:src="${plan.getImgPath()}"></img>
                            <img class="infoImg" th:if="${plan.getImgPath()==null}" src="/public/img/plan/planDefault.jpeg"></img>
                            <div class="infoStatus" >
                                <i class="bi bi-key"></i>
                                <span th:text="${plan.getPlanStatus()}"/></div>

                            <div class="infoSchedule">üóìÔ∏è <span th:text="${plan.getPlanFrom()}"/> ~ <span th:text="${plan.getPlanTo()}"/></div>

                        </div>


                </div>

            </div> <!--Ï¢åÏ∏°ÏÇ¨Ïù¥ÎìúÎã´Í∏∞-->



            <div class="col-md-8 mainSection">

                <div class="row mainHeader">
                    <div class="col-md-2">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary btn-lg dropdown-toggle dayBtn py-0 border-0" data-bs-toggle="dropdown" aria-expanded="false">
                                DAY 01
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">DAY 02</a></li>
                                <li><a class="dropdown-item" href="#">DAY 03</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="btn-group btn-group-horizon btnLine" role="group">
                            <!--Ïù¥ÎØ∏ÏßÄ ÏÇΩÏûÖ-->
                            <button class="btn-group"  type="button" id="imgBtn">
                                <i class="bi bi-image"></i>
                                <input id="imgInput" type="file" style="display: none"/>
                            </button>
                            <!--Î≥¥Í¥ÄÌï®-->
                            <button class="btn-group"  type="button" id="loadBtn">
                                <i class="bi bi-folder2-open"></i>
                            </button>
                            <!-- ÏßÄÏö∞Í∏∞ -->
                            <button class="btn-group"  type="button"  id="removeBtn">
                                <i class="bi bi-trash"></i>
                            </button>
                            <!--ÏÑ†ÌÉù-->
                            <button class="btn-group" type="button" id="selectorBtn">
                                <i class="bi bi-hand-index"></i>
                            </button>
                            <!--Ïù¥Îèô-->
                            <button class="btn-group" type="button"  id="moveBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-arrows-move"></i>
                            </button>
                            <!--Ìéú-->
                            <button class="btn-group"  type="button" id="penBtn">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <!--ÏßÅÏÑ†-->
                            <button class="btn-group"  type="button" id="lineBtn" >
                                <i class="bi bi-slash-lg"></i>
                            </button>
                            <!--Î∞ïÏä§ -->
                            <button class="btn-group"  type="button"  id="rectBtn">
                                <i class="bi bi-square"></i>
                            </button>
                            <!--ÌÖçÏä§Ìä∏ÏûÖÎ†•-->
                            <button class="btn-group" type="button"  id="textBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-fonts"></i>
                            </button>
                            <!--ÌååÎ†àÌä∏-->
                            <button class="btn-group"  type="button"   id="palateBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-palette"></i>
                            </button>
                            <!--Ìè¨Ïä§Ìä∏Ïûá-->
                            <button class="btn-group"  type="button"  id="postBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-sticky"></i>
                            </button>
                            <!--Ïä§ÌÖúÌîÑ-->
                            <button class="btn-group"  type="button" id="stampBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-star"></i>
                            </button>
                            <!--ÏÑ§Ï†ï-->
                            <button class="btn-group"  type="button"  id="settingBtn" style="background-color: #5d5d5d">
                                <i class="bi bi-gear"></i>
                            </button>
                            <!--ÌîåÎü¨Ïä§Î≤ÑÌäº-->
                            <button class="btn-group"  type="button"  id="plusBtn">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                            <!--ÎßàÏù¥ÎÑàÏä§Î≤ÑÌäº-->
                            <button class="btn-group"  type="button"  id="minusBtn">
                                <i class="bi bi-dash-circle"></i>
                            </button>
<!--                            <button class="btn-group red" ></button>-->
<!--                            <button class="btn-group orange"></button>-->
<!--                            <button class="btn-group yellow"></button>-->
<!--                            <button class="btn-group green"></button>-->
<!--                            <button class="btn-group blue"></button>-->
<!--                            <button class="btn-group navy"></button>-->
<!--                            <button class="btn-group purple"></button>-->
<!--                            <button class="btn-group black"></button>-->
<!--                            <button class="btn-group white"></button>-->
<!--                            <button class="btn-group clear"></button>-->

                            </div><!--Î≤ÑÌäºÍ∑∏Î£πÎã´Í∏∞-->
                        </div> <!--col 9-->

                    <div class="col-md-2 scheduleInputBox">
                        <div id="newScheduleBtn">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                    </div>
                </div>


                    <div class="accordion .accordion-flush" id="accordionSection">
                        <div class="accordion-item" th:each="content:${plan.getContents()}">
                            <th:block th:include="/plan/contents"></th:block>
                        </div>
                    </div>

            </div> <!--Î©îÏù∏ÏÑπÏÖòÎã´Í∏∞-->


            <div class="col-md-2">
                <div class="row row-cols-1 sideGrid">
                    <div class="col memberBox">
                        <div class="memberTitle sideTitle">MEMBER</div>
                        <div class="memberContent sideContent">              </div>
                    </div>
                    <div class="col todoListBox">
                        <div class="todoListTitle sideTitle">CHECK_LIST</div>
                        <div class="todoListContent sideContent">Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÎÇ¥Ïö©</div>
                    </div>

                </div>
            </div> <!--Ïö∞Ï∏°ÏÇ¨Ïù¥Îìú Îã´Í∏∞-->




    </div> <!--Í∑∏Î¶¨Îìú row Îã´Í∏∞-->

<!--ÏÉà ÌîåÎûú Î™®Îã¨ Î∂ÄÎ∂Ñ-->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary bg-opacity-10">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">ÏÉà Ïä§ÏºÄÏ•¥ ÏûëÏÑ±</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form  method="post" id="scheduleInsertForm">
                        <div class="row">
                            <div class="col-6">
                                <div class="row">
                                    <input type="text" class="form-control" name="pId" th:value="${plan.getPId()}"  id="floatingId" placeholder="" hidden>
                                    <input type="text" class="form-control" name="tId" value="" id="tId" placeholder="" hidden>
                                    <input type="text" class="form-control" name="sId" value="" id="sId" placeholder="" hidden>

                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="title" id="floatingTitle" placeholder="">
                                            <label for="floatingTitle">Ïó¨ÌñâÏßÄ</label>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="form-floating">
                                            <input type="time" class="form-control" name="sTime" id="sTime" placeholder="">
                                            <label for="sTime">ÏãúÏûëÏãúÍ∞Ñ</label>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="form-floating">
                                            <input type="time" class="form-control" name="eTime" id="eTime" placeholder="" value="">
                                            <label for="eTime">ÎÅùÏãúÍ∞Ñ</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="info" id="info" placeholder="">
                                            <label for="info">Í≤ΩÏú†ÏßÄ & Î©îÎ™®</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="" class="form-control" name="" id="floatingImg" placeholder="">
                                    <label for="floatingImg">Î∂ÅÎßàÌÅ¨ÎÑ£ÏùÑÎ∂ÄÎ∂Ñ</label>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">ÎßåÎì§Í∏∞</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>



    <script th:inline="javascript">

        document.getElementById("imgBtn").addEventListener("click",()=>{
            let input = document.getElementById("imgInput")
            input.click();
            input.addEventListener("change",(e)=>{

            console.log(input.files)
            })
        })



        let bb = document.getElementsByClassName("scheduleLeft")
        Array.from(bb).forEach((e)=>{
            e.addEventListener("click",()=>{
                console.log("ÎêòÎÇò?")
            })
        })

        /*
        Í≤åÏãúÍ∏ÄÏùÑ Î°úÎìú Ìï† Îïå ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
        Ïä§ÏºÄÏ•¥Ïù¥ Ï∂îÍ∞ÄÎêòÍ≥† Í∑∏Î¶ºÌåêÍπåÏßÄ ÎßåÎì† Í≤ΩÏö∞ÏôÄ, Í∑∏Î¶ºÌåêÏùÄ ÎßåÎì§ÏßÄ ÏïäÏùÄ Í≤ΩÏö∞Î•º Íµ¨Î∂ÑÌïòÏó¨ Ï≤òÎ¶¨
         */
        document.addEventListener("DOMContentLoaded",()=>{
            let initArr=[];
            let nBtns = document.querySelectorAll(".newCanvasBtn");
            [# th:each="c,s:${plan.getContents()}"]
            if([[${c.getPath()}]]!=null) initArr.push([[${c.getPath()}]])
            [/];
            initArr.forEach((a)=>{
               let ele = document.querySelector(`#content_${a.conId}`).lastElementChild;
                newCanvas(ele,a.conId,a.canPath);
            });
        });

        // ÏõπÏÜåÏºìÏö©
        const URL="ws://localhost:7777/plan"
        let webSocket;
        webSocket=new WebSocket(URL);


        // ÏÉà Ïä§ÏºÄÏ•¥ Îì±Î°ù Î™®Îã¨
        const newScheduleBtn = document.querySelector("#newScheduleBtn");
        const newScheduleBtnM = new bootstrap.Modal(document.getElementById('staticBackdrop'),{});
        newScheduleBtn.addEventListener("click",()=>{
            newScheduleBtnM.show();
        });

        // ÏÉà Ïä§ÏºÄÏ•¥ Ï†úÏ∂úÏãú
        const scheduleInsertForm = document.getElementById("scheduleInsertForm");
        scheduleInsertForm.onsubmit=registerSchedule;



        //ÏÉà Ïä§ÏºÄÏ•¥ ÏÉùÏÑ±Ïãú @ResponseBody ÏöîÏ≤≠ Î≥¥ÎÇ¥Í≥† Í≤∞Í≥ºÏóê Îî∞Îùº ÏΩúÎû©Ïä§ ÏÉùÏÑ±...ÎÇòÏ§ëÏóê
        async function registerSchedule(e){
            e.preventDefault();
            const data=new FormData(scheduleInsertForm);
            let sTime = !data.get("sTime") ? "--:--" : data.get("sTime");
            let eTime = !data.get("eTime") ? "--:--" : data.get("eTime");
            data.append("time", sTime + " ~ " + eTime)

            let url="/plan/contents/insert.do"
            const resp=await fetch(url,{method:"POST",body:data});
            if(resp.status===200){
                const json=await resp.json();
                document.getElementById("accordionSection").insertAdjacentHTML("afterend",accordionInsert(json.conId,json.time,json.title,json.info))
                newScheduleBtnM.hide();
            }else {
                alert("Îì±Î°ù Ïã§Ìå® status :"+resp.status);
            }
        }




        function newCanvas(ele,conId,path=null){
            let w = document.querySelector(".accordion-item").clientWidth;
            let h = 500/1200*w+16; //16ÏùÄ Î∂ÄÌä∏Ïä§Ìä∏Îû© ÏïÑÏΩîÎîîÏñ∏Î∞îÎîîÏóê ÏÑ§Ï†ïÎêú ÏÉÅÌïò Ìå®Îî©Í∞íÏùÑ Î≥¥Ï†ïÌï¥Ï§Ä Í≤É
            ele.style.height = h +"px";
            let newCanvas = new CanvasCreate(conId, path);
            let canvas = newCanvas.canvas;
            ele.lastElementChild.style.display = "none"
            ele.append(canvas);
        }

        async function newCanvasBtn(ele){
            let conId = ele.parentElement.getAttribute("id").split("_")[1]
            let url =`/plan/contents/canvasHandler.do`
            const resp = await fetch(url,{method:"POST",body:conId});
            const result = await resp.json();
            if(resp.status===200 && result===1){
                newCanvas(ele, conId);
            }else {
                alert("Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ± Ïã§Ìå® status :"+resp.status);
            }
        }

        function accordionInsert(conId, time, title, info){
            return `<div class="accordion-item" style="margin: 0px 20px">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed scheduleBtn" type="button" data-bs-toggle="collapse"
                           data-bs-target="#content_${conId}" aria-expanded="false" aria-controls="#content_${conId}">
                              <div class="container scheduleContainer ">
                                  <div class="row scheduleRow " >
                                      <div class="col col-md-3 scheduleLeft ">
                                          <span class="scheduleTime">${time}</span>
                                      </div>
                                      <p class="col col-md-9 scheduleCenter">
                                          <span class="scheduleTitle">${title}</span>
                                          <span class="scheduleContent">${info}</span>
                                      </p>
                                  </div>
                              </div>
                          </button>
                        </h2>
                        <div id="content_${conId}" class="accordion-collapse collapse " data-bs-parent="#accordionSection">
                            <p class="scheduleSideBtn1 sbHover"><i class="bi bi-three-dots"></i></p>
                            <p class="scheduleSideBtn2 sbHover"><i class="bi bi-trash3"></i></p>
                            <div class="accordion-body">
                                <p class="newCanvasBtn" onclick=newCanvasBtn(this.parentElement)><i class="bi bi-plus-circle"></i></p>
                            </div>
                        </div>
                    </div>`;
        }







    </script>

    <script type="text/javascript" th:src="@{/public/js/plan/canvasFunction.js}"></script>
</div> <!--Î†àÏù¥ÏïÑÏõÉ Îã´Í∏∞-->
</html>

